<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta name="robots" content="noindex">
<style>
html {
  box-sizing: border-box;
  margin:0;
  padding:0;
}

*, *::before, *::after {
  box-sizing: inherit;
}

body {
	width:100%;
	margin:0 auto;
	font-size:3vw;
	font-family: "Noto Sans JP", "Noto Sans", -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", "Arial", sans-serif;
}
body > p {
	width:auto;
	padding:0.25%;
	font-size:100%;
	word-break: break-all;  /* 長い文字列を折り返し */
}
#inputform > div{
	width:auto;
	margin:0 auto;
	display:flex;
	flex-wrap:nowrap;
	padding:2% 0;
}
#inputform .th {
	width:30%;
	font-size:150%;
}
#inputform input {
	font-size:150%;
	width:10vw;
}
#inputform .u_base {
	width:45vw;
}
#inputform .u_ans {
	background-color:#ff9;
}
#inputform .u_btn {
	font-size:125%;
	width:15vw;
}
#inputform span {
	font-size:150%;
}
.buttonarea {
	width:100%;
	display:flex;
	flex-wrap:nowrap;
}
.buttonarea input {
	width:50%;
	font-size:120%;
	padding:2.5% 0;
}
#subbtn {
	font-size:110%;
}
/*PCだと文字が大きすぎるので調整*/
@media screen and (min-width: 641px){
	body {
		font-size:1.5vw;
	}
}
</style>
<script>
//とりあえず100ミリ秒＝0.1秒に一回更新
let milliSec = 0;
let interval = 100;
let passTimer;
let scoreArray = [[]];

//-----------------------------

//-----------------------------
//読み込み後の処理
document.addEventListener('DOMContentLoaded', function(){
	getSubnetInfo();
	setQandA();
	setTimer();
});
//-----------------------------

//-----------------------------
//以下、関数
//ランダムな0～_max-1の整数を生成（テスト用）
function rnd(_max) {
	return Math.floor(Math.random()*_max);
}
function setTimer() {
	clearInterval(passTimer);
	milliSec = 0;
	passTimer = setInterval(function(){
		if (milliSec > 300 * 1000) {
			clearInterval(passTimer);
		}
		else {
			milliSec += interval;
		}
		//console.log("経過時間:"+milliSec);
		document.getElementById("timer").innerHTML = Math.floor(milliSec/1000);
	},interval);
	
	//入力情報の初期化
	document.querySelectorAll(".u_ans").forEach(el => {
	  //console.log(el.value);
	  el.value = "";
	});
}
//INPUT系の初期化
function initQandA() {
	setTimer();
	document.getElementById("answer").innerHTML = "";
}
let addressObj = {};
//プレフィックス長からサブネットマスクを生成（未使用）
function getMaskFromPrefix(prefixLength) {
	const binaryMask = "1".repeat(prefixLength).padEnd(32, "0");
	const subnetMask = Array.from({ length: 4 }, (_, i) =>
	  parseInt(binaryMask.slice(i * 8, (i + 1) * 8), 2)
	).join(".");
	console.log(subnetMask); // 出力: 255.255.255.0
	return subnetMask;
}

//ランダムなIPアドレス＋プレフィックス長を生成
function getRandomIpAndPrefix() {
	//IPv4アドレス生成
	const ip = Array.from({ length: 4 }, () => Math.floor(Math.random() * 256)).join(".");
	//プレフィックス長（CIDR）生成：一般的な範囲でランダム（8〜30）
	const prefix = Math.floor(Math.random() * (30 - 8 + 1)) + 8;
	//使用例
	//console.log("getRandomIpAndPrefix",`${ip}/${prefix}`); // 例: 192.168.24.11/23
	//プレフィックス長が8の倍数だったらやり直す
	if (prefix % 8 == 0) {return getRandomIpAndPrefix();}
	else {return `${ip}/${prefix}`;}
}

//IPアドレスとプレフィックス長を渡して、ブロード、ネットワーク、サブネットマスクを返す
function getSubnetInfo(keystr,cidr) {
	if (cidr == null) {
		cidr = getRandomIpAndPrefix();
	}
	const [ipStr, prefixStr] = cidr.split("/");
	const prefixLength = parseInt(prefixStr);
	try {
	}
	catch (e) {
		const [ipStr, prefixStr] = ["255.255.255","32"];
		const prefixLength = parseInt(prefixStr);
		console.warn(cidr,e);
	}

	if (prefixLength < 0 || prefixLength > 32) {
		throw new Error("Invalid prefix length");
	}
	// IPを整数に変換
	const ipParts = ipStr.split(".").map(Number);
	const ipInt =
		(ipParts[0] << 24) |
		(ipParts[1] << 16) |
		(ipParts[2] << 8) |
		ipParts[3];
	// サブネットマスクを整数で生成
	const maskInt = (0xFFFFFFFF << (32 - prefixLength)) >>> 0;

	// ネットワークアドレス
	const networkInt = ipInt & maskInt;
	
	// ブロードキャストアドレス
	const broadcastInt = networkInt | (~maskInt >>> 0);

	// 整数をIPv4文字列に変換する関数
	const intToIp = (int) =>
		[(int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255].join(".");
	
	addressObj = {
		baseAddress: cidr,
		subnetMask: intToIp(maskInt),
		networkAddress: intToIp(networkInt),
		broadcastAddress: intToIp(broadcastInt),
	};
	if (keystr == null) {
		return addressObj;
	}
	else {
		return addressObj[keystr];
	}
	// 使用例
	//console.log(getSubnetInfo("172.16.201.33/18"));
}

//問題文の挿入
function setQandA() {
	let _element = document.getElementById("question");
	let _num = rnd(33);
	let _txt = "サブネットマスク(SUB)、ネットワークアドレス(NWA)、ブロードキャストアドレス(BCA)を求めなさい。";
	_element.innerHTML = ""+_txt;
	
	//BASEにアドレスを挿入
	setTimeout(function(){
		_element = document.querySelector("#baseAddress input");
		_element.value = addressObj["baseAddress"];
		/*
		//input複数対応予定
		let inputs = document.querySelectorAll("#baseAddress input");
		let val = 0;
		for (let i = 0; i < 4; i++) {
			_element = inputs[i];
			_val = addressObj["baseAddress"].split(".")[i];
			if (typeof _val == "Number") {
				_element.value = _val;
			}
			else {
				_element.value = _val.split("/")[0];
				_element = inputs[i+1];
				_element.value = _val.split("/")[1];				
			}
		}
		*/
		//_element = document.querySelector("#baseAddress input");
		//_element.value = ""+addressObj["baseAddress"];
	},10);
	
	//正解を挿入
	let isChecked = document.getElementById("check_alwayanswer").checked;
	if (isChecked) {insertAnswer(getAnswer(true));}
	
	//ヒント挿入
	isChecked = document.getElementById("check_semiauto").checked;
	if (isChecked) {insertHint();}
	else {resetHint();}
	
}
//問題を更新した際の適用（履歴からの復元や直接入力など）
function applyQuestion(_value) {
	let _element = document.querySelector("#baseAddress input");
	if (_value == null) {
		_value = _element.value;
	}
	addressObj["baseAddress"] = _value;
	_element.value = _value;
	getSubnetInfo(null,_value);
	setQandA();
}
//ヒントの色付けのリセット
function resetHint() {
	for (key in addressObj) {
		if (key == "baseAddress") {continue;}
		_element = document.querySelector("#"+key+" input");
		//let spritTarget = _element.value.split(".");
		let inputs = document.querySelectorAll("#" + key + " input");
		//console.log(key,inputs);
		for (let i = 0; i < 4; i++) {
			_element = inputs[i]; // N番目（0が先頭）
			_element.removeAttribute("disabled");
			_element.style.backgroundColor = "#ff9";
			_element.value = "";
		}
	}
}
//サブネットマスクと各アドレスの変化する部分のみを「-」として挿入
function insertHint(_isAutoset) {
	if (_isAutoset == false) {
		resetHint();
		return;
	}
	let _element;
	let _splitBase = addressObj["baseAddress"].split(".");
	_splitBase[_splitBase.length-1] = _splitBase[_splitBase.length-1].split("/")[0];
	let _splitSub = addressObj["subnetMask"].split(".");
	let _octet = 3;
	for (let i = 0; i < _splitSub.length; i++) {
		if (_splitSub[i] != 0 && _splitSub[i] != 255) {
			_octet = i;
		}
	}
	//console.log("変化するオクテット："+(_octet+1));
	let _insertStr = "";
	let _insertNum = 0;
	for (key in addressObj) {
		if (key == "baseAddress") {continue;}
		_element = document.querySelector("#"+key+" input");
		//let spritTarget = _element.value.split(".");
		let inputs = document.querySelectorAll("#" + key + " input");
		//console.log(key,inputs);
		for (let i = 0; i < 4; i++) {
			_element = inputs[i]; // N番目（0が先頭）
			//console.log(i,_element);
			//if (i != 0) {_insertStr += ".";}
			if (_splitSub[i] == 0) {
				if (key == "networkAddress" || key == "subnetMask") {
					_insertNum = 0;
				}
				else {
					_insertNum = 255;
				}
				//_element.setAttribute("tabindex", "-1");
				_element.setAttribute("disabled", true);
				_element.style.backgroundColor = "transparent";
			}
			else if (_splitSub[i] == 255) {
				if (key == "subnetMask") {
					_insertNum = _splitSub[i];
				}
				else {
					_insertNum = _splitBase[i];
				}
				//_element.setAttribute("tabindex", "-1");
				_element.setAttribute("disabled", true);
				_element.style.backgroundColor = "transparent";
			}
			else {
				//_element.setAttribute("tabindex", "");
				_element.removeAttribute("disabled");
				_element.style.backgroundColor = "#ff9";
				_insertNum = "";
				//console.log(key,i,_element);
			}
			_element.value = _insertNum;
		}
	}
}
//採点（各アドレスが正解で25点*3、残りは経過時間で加点）
function getScore() {
	let _score = 0;
	let _valueStr = "";
	for (key in addressObj) {
		if (key != "baseAddress") {
			_valueStr = "";
			let _element = document.querySelector("#"+key+" input");
			let inputs = document.querySelectorAll("#" + key + " input");
			for (let i = 0; i < 4; i++) {
				if (i != 0) {
					_valueStr += ".";
				}
				_valueStr += inputs[i].value;
			}
			//console.log(_valueStr+" vs "+addressObj[key]);
			if (_valueStr == addressObj[key]) {
				_score += 25;
			}
		}
	}
	//経過時間ボーナスは通常時は60秒。手抜きは120秒
	let _baseSec = 60;
	let isChecked = document.getElementById("check_semiauto").checked;
	if (isChecked == true) {
		_baseSec = _baseSec * 0.5;
	}
	if (_score >= 25 * 3) {
		if (milliSec <= _baseSec*1000) {
			_score += 25;			
		}
		else if (milliSec <= _baseSec*2*1000) {
				_score += 15;			
		}
		else if (milliSec <= _baseSec*3*1000) {
				_score += 5;
		}
	}
	return _score;
}
//正解のHTMLを生成して返す（将来的には整理が必要）
function getAnswer(_isAutoAnser) {
	let _id = "";
	let _value = "";
	let _valueStr = "";
	let _element = document.getElementById("answer");
	//_element.innerHTML = ""+JSON.stringify(addressObj);
	let _answertext = "";

	for (key in addressObj) {
		if (key != "baseAddress") {
			//input複数対応予定
			_element = document.querySelector("#"+key+" div");
			_value = _element.textContent;
			_answertext += (_value+":");
			_valueStr = "";
			_element = document.querySelector("#"+key+" input");
			let inputs = document.querySelectorAll("#" + key + " input");
			for (let i = 0; i < 4; i++) {
				if (i != 0) {
					_valueStr += ".";
				}
				_valueStr += inputs[i].value;
			}
			//console.log(key,_valueStr);
			if (_valueStr == addressObj[""+key]) {
				_answertext += ("<span style=''>"+"OK!!"+"</span>");
			}
			else if (_isAutoAnser == true) {
				_answertext += ("<span style='opacity:0.5;'>"+addressObj[key]+"</span>");
			}
			else {
				_answertext += ("<span style='color:red;'>"+addressObj[key]+"</span>");
			}
			_answertext += "<br>";
		}
	}
	//console.log("ans="+_answertext);
	return _answertext;
}
//正解のHTMLを挿入
function insertAnswer(_answertext) {
	_element = document.getElementById("answer");
	_element.innerHTML = ""+_answertext;
}
//スコア一覧のHTMLを更新
function renderScoreList() {
  let _element = document.getElementById("score");
  _element.innerHTML = "<pre>";
  let _linenum = Math.min(scoreArray.length, 10);
  for (let i = 0; i < _linenum; i++) {
    let entry = scoreArray[i];
    if (!entry || entry.length < 3 || typeof entry[1] !== "number") continue; // 不正データをスキップ

    let _judge = entry[1] >= 60 ? "✅" : "❌";
    _element.innerHTML += `
      ${_judge}\t${entry[0]}\t${entry[1]}点\t${entry[2]}秒\t
      <input type="button" value="🔁" onclick="applyQuestion('${entry[0]}')"><br>
    `;
  }
  _element.innerHTML += "</pre>";
}
function insertScore(_score, _address = null, _cleartime = null) {
  if (_score == null) {
    _score = getScore();
  }
  if (_address == null) {
    _address = addressObj["baseAddress"];
  }
  if (_cleartime == null) {
    _cleartime = Math.floor(milliSec / 1000);
  }

  // 不正な値を防ぐためのバリデーション
  if (!_address || typeof _score !== "number" || typeof _cleartime !== "number") {
    console.warn("無効なスコアデータが検出されました。挿入をスキップします。");
    return;
  }

  scoreArray.unshift([_address, _score, _cleartime]);

  renderScoreList();
  setAverageStats();
  //saveHistory();
}

//デバッグ用の関数（検証不足のため保存機能は後回し）
function setAverageStats() {
	let stats = getAverageStats();
	document.getElementById("avgscore").textContent = stats.avgScore;
	document.getElementById("avgtime").textContent = stats.avgTime;	
}
function getAverageStats() {
  let totalScore = 0;
  let totalTime = 0;
  let count = 0;
  scoreArray.forEach(entry => {
    if (entry[1] >= 0) {
      totalScore += entry[1];
      totalTime += entry[2];
      count++;
    }
  });
  return {
    avgScore: count ? Math.round(totalScore / count) : 0,
    avgTime: count ? Math.round(totalTime / count) : 0
  };
}
function saveHistory() {
	//保存機能
	let stats = getAverageStats();
	document.getElementById("avgscore").textContent = stats.avgScore;
	document.getElementById("avgtime").textContent = stats.avgTime;

	// 履歴保存
	localStorage.setItem("subnetHistory", JSON.stringify(scoreArray));
}
function loadHistory() {
  const saved = localStorage.getItem("subnetHistory");
  if (saved) {
    scoreArray = JSON.parse(saved);
    renderScoreList();
    setAverageStats();
  }
  getSubnetInfo();
  setQandA();
  setTimer();
}
//<p>平均点：<span id="avgscore">--</span>点　平均時間：<span id="avgtime">--</span>秒</p>
</script>
</head>
<body>
<p id="question">問題文が入ります</p>
<form id="inputform">
<div id="baseAddress">
<div class="th">BASE</div>
<input class="u_base" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<input class="u_btn" type="button" value="変更" onclick="applyQuestion();">
<!--
<input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>/</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
-->
</div>
<div id="subnetMask">
<div class="th">SUB</div>
<input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
 <span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
</div>
<div id="networkAddress">
<div class="th">NWA</div>
<input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
</div>
<div id="broadcastAddress">
<div class="th">BCA</div>
<input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
<span>.</span> <input class="u_ans" type="tel" inputmode="numeric" pattern="[0-9.]*" placeholder="" />
</div>
<!--
<input type="text" inputmode="numeric" pattern="[0-9./]*" placeholder="例: 192.168.1.1/24(スマホ無理そう)">
-->
</form>
<p id="subbtn">
<label><input type="checkbox" id="check_alwayanswer" value="" onclick="insertAnswer(getAnswer(true))">正解を常に表示</label>
　<label><input type="checkbox" id="check_semiauto" value="" onclick="insertHint(this.checked)">対象以外を自動入力</label>
　経過時間：<span id="timer"></span>秒
</p>
<p id="answer"></p>
<!--
計算手順のメモ
・bit=プレフィックス長の差分を求める
・num=2のbit乗でビット数を求める(例:bitが4→2の4乗＝16)
・サブネットマスク(256-2のnum乗)を求める
・対象オクテットを見極める
・各アドレスの対象以外のアドレスを入力
・nwa=対象オクテットを計算「アドレスの値/num*bit」
・bca=対象オクテットを計算「nwa＋bit-1」
例：8.188.41.99/28→32-28=4(bit)→16(num)→99/16=6→16*6=96(nwa)→96+16-1=111(sub)
<pre>
| プレ | 2進数     | 10進数 | サブ数 |
|------|----------|--------|--------|
| /0   | 00000000 | 0      | 1      |
| /1   | 10000000 | 128    | 2      |
| /2   | 11000000 | 192    | 4      |
| /3   | 11100000 | 224    | 8      |
| /4   | 11110000 | 240    | 16     |
| /5   | 11111000 | 248    | 32     |
| /6   | 11111100 | 252    | 64     |
| /7   | 11111110 | 254    | 128    |
| /8   | 11111111 | 255    | 256    |
</pre>
-->
<div class="buttonarea">
<input type="button" value="正解を表示" onclick="clearInterval(passTimer);insertAnswer(getAnswer());">
<input type="button" value="次の問題へ" onclick="insertScore(getScore());initQandA();setQandA(getSubnetInfo())">
</div>
<div class="buttonarea">
	<!--
	<input type="button" value="再読み込み" onclick="location.reload();" style="font-size:120%; padding:1em;">
	<input type="button" value="結果一覧" onclick="insertScore()">
	-->
</div>
<br>
<details open>
<summary>結果一覧　平均点：<span id="avgscore">--</span>点　平均時間：<span id="avgtime">--</span>秒</summary>
<p id="score"></p>
</details>
</body>
